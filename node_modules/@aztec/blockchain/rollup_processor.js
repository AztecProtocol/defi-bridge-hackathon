"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RollupProcessor = void 0;
const address_1 = require("@aztec/barretenberg/address");
const bridge_id_1 = require("@aztec/barretenberg/bridge_id");
const note_algorithms_1 = require("@aztec/barretenberg/note_algorithms");
const rollup_proof_1 = require("@aztec/barretenberg/rollup_proof");
const tx_hash_1 = require("@aztec/barretenberg/tx_hash");
const ethers_1 = require("ethers");
const RollupProcessor_json_1 = require("./artifacts/contracts/RollupProcessor.sol/RollupProcessor.json");
const solidity_format_signatures_1 = require("./solidity_format_signatures");
const IDefiBridgeEvent = new ethers_1.utils.Interface([
    'event DefiBridgeProcessed(uint256 indexed bridgeId, uint256 indexed nonce, uint256 totalInputValue, uint256 totalOutputValueA, uint256 totalOutputValueB, bool result)',
]);
const fixEthersStackTrace = (err) => {
    err.stack += new Error().stack;
    throw err;
};
class RollupProcessor {
    constructor(rollupContractAddress, provider) {
        this.rollupContractAddress = rollupContractAddress;
        this.provider = provider;
        this.rollupProcessor = new ethers_1.Contract(rollupContractAddress.toString(), RollupProcessor_json_1.abi, this.provider);
    }
    get address() {
        return this.rollupContractAddress;
    }
    async feeDistributor() {
        return address_1.EthAddress.fromString(await this.rollupProcessor.feeDistributor());
    }
    async numberOfAssets() {
        return +(await this.rollupProcessor.numberOfAssets());
    }
    async numberOfBridgeCalls() {
        return +(await this.rollupProcessor.numberOfBridgeCalls());
    }
    async nextRollupId() {
        return +(await this.rollupProcessor.nextRollupId());
    }
    async dataSize() {
        return +(await this.rollupProcessor.dataSize());
    }
    async dataRoot() {
        return Buffer.from((await this.rollupProcessor.dataRoot()).slice(2), 'hex');
    }
    async nullRoot() {
        return Buffer.from((await this.rollupProcessor.nullRoot()).slice(2), 'hex');
    }
    async rootRoot() {
        return Buffer.from((await this.rollupProcessor.rootRoot()).slice(2), 'hex');
    }
    async defiRoot() {
        return Buffer.from((await this.rollupProcessor.defiRoot()).slice(2), 'hex');
    }
    async defiInteractionHash() {
        return Buffer.from((await this.rollupProcessor.defiInteractionHash()).slice(2), 'hex');
    }
    async totalDeposited() {
        return (await this.rollupProcessor.getTotalDeposited()).map(v => BigInt(v));
    }
    async totalWithdrawn() {
        return (await this.rollupProcessor.getTotalWithdrawn()).map(v => BigInt(v));
    }
    async totalFees() {
        return (await this.rollupProcessor.getTotalFees()).map(v => BigInt(v));
    }
    async totalPendingDeposit() {
        return (await this.rollupProcessor.getTotalPendingDeposit()).map(v => BigInt(v));
    }
    async weth() {
        return address_1.EthAddress.fromString(await this.rollupProcessor.weth());
    }
    async getSupportedAssets() {
        const assetAddresses = await this.rollupProcessor.getSupportedAssets();
        return assetAddresses.map((a) => address_1.EthAddress.fromString(a));
    }
    async setSupportedAsset(assetAddress, supportsPermit, signer) {
        const rollupProcessor = this.getContractWithSigner(signer);
        const tx = await rollupProcessor.setSupportedAsset(assetAddress.toString(), supportsPermit);
        return tx_hash_1.TxHash.fromString(tx.hash);
    }
    async getAssetPermitSupport(assetId) {
        return this.rollupProcessor.getAssetPermitSupport(assetId);
    }
    async getEscapeHatchStatus() {
        const [escapeOpen, blocksRemaining] = await this.rollupProcessor.getEscapeHatchStatus();
        return { escapeOpen, blocksRemaining: +blocksRemaining };
    }
    async createEscapeHatchProofTx(proofData, viewingKeys, signatures, signer) {
        const rollupProcessor = this.getContractWithSigner(signer);
        const formattedSignatures = solidity_format_signatures_1.solidityFormatSignatures(signatures);
        const tx = await rollupProcessor.populateTransaction
            .escapeHatch(`0x${proofData.toString('hex')}`, formattedSignatures, Buffer.concat(viewingKeys))
            .catch(fixEthersStackTrace);
        return Buffer.from(tx.data.slice(2), 'hex');
    }
    async createRollupProofTx(proofData, signatures, viewingKeys, providerSignature, providerAddress, feeReceiver, feeLimit) {
        const rollupProcessor = new ethers_1.Contract(this.rollupContractAddress.toString(), RollupProcessor_json_1.abi);
        const formattedSignatures = solidity_format_signatures_1.solidityFormatSignatures(signatures);
        const tx = await rollupProcessor.populateTransaction
            .processRollup(`0x${proofData.toString('hex')}`, formattedSignatures, Buffer.concat(viewingKeys), providerSignature, providerAddress.toString(), feeReceiver.toString(), feeLimit)
            .catch(fixEthersStackTrace);
        return Buffer.from(tx.data.slice(2), 'hex');
    }
    async depositPendingFunds(assetId, amount, permitArgs, signer) {
        const rollupProcessor = this.getContractWithSigner(signer);
        const depositorAddress = await rollupProcessor.signer.getAddress();
        if (permitArgs) {
            const tx = await rollupProcessor
                .depositPendingFundsPermit(assetId, amount, depositorAddress, this.rollupProcessor.address, permitArgs.approvalAmount, permitArgs.deadline, permitArgs.signature.v, permitArgs.signature.r, permitArgs.signature.s, { value: assetId === 0 ? amount : undefined })
                .catch(fixEthersStackTrace);
            return tx_hash_1.TxHash.fromString(tx.hash);
        }
        else {
            const tx = await rollupProcessor
                .depositPendingFunds(assetId, amount, depositorAddress, {
                value: assetId === 0 ? amount : undefined,
            })
                .catch(fixEthersStackTrace);
            return tx_hash_1.TxHash.fromString(tx.hash);
        }
    }
    async approveProof(proofHash, signer) {
        const rollupProcessor = this.getContractWithSigner(signer);
        const tx = await rollupProcessor.approveProof(proofHash).catch(fixEthersStackTrace);
        return tx_hash_1.TxHash.fromString(tx.hash);
    }
    async getUserPendingDeposit(assetId, account) {
        return BigInt(await this.rollupProcessor.getUserPendingDeposit(assetId, account.toString()));
    }
    async getUserProofApprovalStatus(address, proofHash) {
        return await this.rollupProcessor.depositProofApprovals(address.toString(), proofHash);
    }
    async getEarliestBlock() {
        const net = await this.provider.getNetwork();
        return net.chainId === 1 ? 11967192 : 0;
    }
    /**
     * Returns all rollup blocks from (and including) the given rollupId, with >= minConfirmations.
     *
     * A normal geth node has terrible performance when searching event logs. To ensure we are not dependent
     * on third party services such as Infura, we apply an algorithm to mitigate the poor performance.
     * The algorithm will search for rollup events from the end of the chain, in chunks of blocks.
     * If it finds a rollup <= to the given rollupId, we can stop searching.
     *
     * The worst case situation is when requesting all rollups from rollup 0, or when there are no events to find.
     * In this case, we will have ever degrading performance as we search from the end of the chain to the
     * block returned by getEarliestBlock() (hardcoded on mainnet). This is a rare case however.
     *
     * The more normal case is we're given a rollupId that is not 0. In this case we know an event must exist.
     * Further, the usage pattern is that anyone making the request will be doing so with an ever increasing rollupId.
     * This lends itself well to searching backwards from the end of the chain.
     *
     * The chunk size affects performance. If no previous query has been made, or the rollupId < the previous requested
     * rollupId, the chunk size is to 100,000. This is the case when the class is queried the first time.
     * 100,000 blocks is ~10 days of blocks, so assuming there's been a rollup in the last 10 days, or the client is not
     * over 10 days behind, a single query will suffice. Benchmarks suggest this will take ~2 seconds per chunk.
     *
     * If a previous query has been made and the rollupId >= previous query, the first chunk will be from the last result
     * rollups block to the end of the chain. This provides best performance for polling clients.
     */
    async getRollupBlocksFrom(rollupId, minConfirmations) {
        const earliestBlock = await this.getEarliestBlock();
        let end = await this.provider.getBlockNumber();
        const chunk = 100000;
        let start = this.lastQueriedRollupId === undefined || rollupId < this.lastQueriedRollupId
            ? Math.max(end - chunk, 0)
            : this.lastQueriedRollupBlockNum;
        let events = [];
        while (end > earliestBlock) {
            const rollupFilter = this.rollupProcessor.filters.RollupProcessed();
            const rollupEvents = await this.rollupProcessor.queryFilter(rollupFilter, start, end);
            events = [...rollupEvents, ...events];
            if (events.length && events[0].args.rollupId.toNumber() <= rollupId) {
                this.lastQueriedRollupId = rollupId;
                this.lastQueriedRollupBlockNum = events[events.length - 1].blockNumber;
                break;
            }
            end = Math.max(start - 1, 0);
            start = Math.max(end - chunk, 0);
        }
        return this.getRollupBlocksFromEvents(events.filter(e => e.args.rollupId.toNumber() >= rollupId), minConfirmations);
    }
    async getRollupBlocksFromEvents(rollupEvents, minConfirmations) {
        const meta = (await Promise.all(rollupEvents.map(event => Promise.all([
            event.getTransaction(),
            event.getBlock(),
            event.getTransactionReceipt(),
            this.getDefiBridgeEvents(event.blockNumber),
        ])))).filter(m => m[0].confirmations >= minConfirmations);
        return meta.map(meta => this.decodeBlock({ ...meta[0], timestamp: meta[1].timestamp }, meta[2], meta[3]));
    }
    async getDefiBridgeEvents(blockNo) {
        const filter = this.rollupProcessor.filters.DefiBridgeProcessed();
        const defiBridgeEvents = await this.rollupProcessor.queryFilter(filter, blockNo, blockNo);
        return defiBridgeEvents.map((log) => {
            const { args: { bridgeId, nonce, totalInputValue, totalOutputValueA, totalOutputValueB, result }, } = IDefiBridgeEvent.parseLog(log);
            return new note_algorithms_1.DefiInteractionNote(bridge_id_1.BridgeId.fromBigInt(BigInt(bridgeId)), +nonce, BigInt(totalInputValue), BigInt(totalOutputValueA), BigInt(totalOutputValueB), result);
        });
    }
    decodeBlock(tx, receipt, interactionResult) {
        const rollupAbi = new ethers_1.utils.Interface(RollupProcessor_json_1.abi);
        const result = rollupAbi.parseTransaction({ data: tx.data });
        const rollupProofData = Buffer.from(result.args.proofData.slice(2), 'hex');
        const viewingKeysData = Buffer.from(result.args.viewingKeys.slice(2), 'hex');
        return {
            created: new Date(tx.timestamp * 1000),
            txHash: tx_hash_1.TxHash.fromString(tx.hash),
            rollupProofData,
            viewingKeysData,
            interactionResult,
            rollupId: rollup_proof_1.RollupProofData.getRollupIdFromBuffer(rollupProofData),
            rollupSize: rollup_proof_1.RollupProofData.getRollupSizeFromBuffer(rollupProofData),
            gasPrice: BigInt(tx.gasPrice.toString()),
            gasUsed: receipt.gasUsed.toNumber(),
        };
    }
    getContractWithSigner(signer) {
        const ethSigner = !signer
            ? this.provider.getSigner(0)
            : signer instanceof address_1.EthAddress
                ? this.provider.getSigner(signer.toString())
                : signer;
        return new ethers_1.Contract(this.rollupContractAddress.toString(), RollupProcessor_json_1.abi, ethSigner);
    }
}
exports.RollupProcessor = RollupProcessor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sbHVwX3Byb2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yb2xsdXBfcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHlEQUF5RDtBQUl6RCw2REFBeUQ7QUFDekQseUVBQTBFO0FBQzFFLG1FQUFtRTtBQUNuRSx5REFBcUQ7QUFHckQsbUNBQXdEO0FBQ3hELHlHQUFrRztBQUNsRyw2RUFBd0U7QUFFeEUsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLGNBQUssQ0FBQyxTQUFTLENBQUM7SUFDM0Msd0tBQXdLO0NBQ3pLLENBQUMsQ0FBQztBQUVILE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxHQUFVLEVBQUUsRUFBRTtJQUN6QyxHQUFHLENBQUMsS0FBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDO0lBQ2hDLE1BQU0sR0FBRyxDQUFDO0FBQ1osQ0FBQyxDQUFDO0FBRUYsTUFBYSxlQUFlO0lBSzFCLFlBQW9CLHFCQUFpQyxFQUFVLFFBQXNCO1FBQWpFLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQWM7UUFDbkYsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGlCQUFRLENBQUMscUJBQXFCLENBQUMsUUFBUSxFQUFFLEVBQUUsMEJBQVMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEcsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDO0lBQ3BDLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYztRQUNsQixPQUFPLG9CQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYztRQUNsQixPQUFPLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLENB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